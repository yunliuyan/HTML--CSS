<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<title>DEMO</title>
	<style type="text/css">
    * {
	margin: 0;
	padding: 0;
}

video {
	display: block;
	height: 400px;
	width: 300px;
	margin: 0 auto;
}

canvas {
	position: fixed;
	top: 100%;
	left: 0;
	z-index: -1;
}

.controls {
	padding: 10px 20px;
	text-align: center;
}
.controls-btn {
	padding: 10px;
}

.image-list {
	margin: 0 auto;
	width: 400px;
}

.image-wrap {
	position: relative;
	margin: 10px 0;
}

.image-img {
	display: block;
}

.image-label {
	position: absolute;
	right: 0;
	bottom: 0;
	padding: 0 10px;
	font-size: 12px;
	color: #333;
	background: rgba(150,150,150,0.5);
}
  </style>
</head>
<body>
	<video autoplay playsinline controls="true"></video>
	<div class="controls">
		<button class="ctrl-capture controls-btn" id="capture">Capture</button>
	</div>
	<canvas width="4000" height="3000"></canvas>
	<div class="image-list"></div>
	<script>
      (function () {
	var video = document.querySelector('video')
	var canvas = document.querySelector('canvas')
	var mediaStream

	document.querySelector('#capture').addEventListener('click', capturePicture)
	navigator.mediaDevices.getUserMedia = navigator.mediaDevices.getUserMedia || navigator.mediaDevices.webkitGetUserMedia || navigator.mediaDevices.mozGetUserMedia
	navigator.mediaDevices.getUserMedia({ audio: false, video: {height:4000,width:3000} })
		.then(function(stream) {
			mediaStream = stream
			// Older browsers may not have srcObject
			if ("srcObject" in video) {
				video.srcObject = stream
			} else {
				// Avoid using this in new browsers, as it is going away.
				video.src = window.URL.createObjectURL(stream)
			}
			video.onloadedmetadata = function(e) {
				video.play()
			}
		})
		.catch(function(err) {
			alert(err.name + ": " + err.message)
		})

	function capturePicture() {
		if (mediaStream) {
			let track = mediaStream.getVideoTracks()[0]
			let imageCapture = new ImageCapture(track)
			imageCapture.grabFrame()
				.then(img => {	
					drawCanvas(canvas, img)
				}
				)
				.then(() => addImageFromCanvas())
				.catch(e => alert(`${e.name}:\n${e.message}`))
		}
	}

	function drawCanvas(canvas, img) {
		let style = getComputedStyle(canvas)
		canvas.width = parseInt(style.width.split('px'), 10)
		canvas.height = parseInt(style.height.split('px'), 10)
		let ratio  = Math.min(canvas.width / img.width, canvas.height / img.height);
		let x = (canvas.width - img.width * ratio) / 2;
		let y = (canvas.height - img.height * ratio) / 2;
		let context = canvas.getContext('2d')
		context.clearRect(0, 0, canvas.width, canvas.height);
		context.drawImage(img, 0, 0, img.width, img.height, x, y, img.width * ratio, img.height * ratio);
	}

	function addImageFromCanvas() {
		prepend(document.querySelector('.image-list'), getImageWrap(canvas.toDataURL("image/png")))
	}

	function getImageWrap(imgUrl) {
		var wrap = document.createElement('div')
		wrap.className = 'image-wrap'
		var img = document.createElement('img')
		img.className = 'image-img'
		img.src = imgUrl
		var label = document.createElement('div')
		label.className = 'image-label'
		label.textContent = formatDate(new Date())
		wrap.appendChild(img)
		wrap.appendChild(label)
		return wrap
	}

	function prepend(parent, child) {
		let firstChild = parent.firstChild
		if (firstChild) {
			parent.insertBefore(child, firstChild)
		} else {
			parent.appendChild(child)
		}
	}

	function formatDate(date) {
		return `${date.getFullYear()}-${date.getMonth() + 1}-${date.getDate()} ` +
			`${date.getHours()}:${date.getMinutes()}:${date.getSeconds()}`
	}
})()

  </script>
</body>
</html>